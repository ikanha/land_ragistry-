# Land Registry Management System - Deployment Instructions

## 1. Introduction

This document provides instructions for deploying and running the Land Registry Management System. The system consists of a Hyperledger Fabric blockchain network and a web application that interacts with it.

## 2. Prerequisites

Before you begin, ensure you have the following installed on your system:

*   **Docker:** Version 20.10.x or later (for running Hyperledger Fabric components and the web application).
*   **Docker Compose:** Version 1.29.x or later (for orchestrating Docker containers).
*   **Node.js:** Version 16.x or 18.x (for the web application backend and chaincode if not using pre-built binaries for tools).
*   **npm:** Version 8.x or later (Node.js package manager).
*   **Git:** For cloning the project repository (if applicable) or managing files.
*   **Hyperledger Fabric Binaries (cryptogen, configtxgen):** Version 2.5.x. The `network.sh` script attempts to download these if not found in `land-registry-fabric/bin`. Ensure `curl` and `tar` are available for this.

## 3. Project Structure

The project is organized into the following main directories, which will be provided as a zip archive:

*   `land-registry-fabric/`: Contains all Hyperledger Fabric network configurations, scripts, and crypto material.
    *   `config/`: Contains `crypto-config.yaml`, `configtx.yaml`, and generated CCP files (`ccp-Org1.yaml`, `ccp-Org2.yaml`).
    *   `scripts/`: Contains `network.sh` for managing the Fabric network and `channel_operations.sh` (generated by `network.sh`).
    *   `docker-compose.yaml`: Defines the Fabric network services.
    *   `crypto-config/` (Generated): Contains cryptographic material for organizations.
    *   `channel-artifacts/` (Generated): Contains genesis block and channel transaction files.
    *   `bin/` (Potentially downloaded by `network.sh`): Contains Fabric binary tools.
*   `chaincode/`: Contains the smart contract (chaincode) for the land registry.
    *   `landregistry/javascript/`: Node.js chaincode project.
        *   `lib/landregistrycontract.js`: Core chaincode logic.
        *   `index.js`: Chaincode entry point.
        *   `package.json`: Node.js project definition.
*   `land-registry-app/`: Contains the web application.
    *   `public/index.html`: Frontend HTML and JavaScript.
    *   `server.js`: Node.js Express backend server.
    *   `package.json`: Node.js project definition.
    *   `wallet/` (Generated at runtime): Stores user identities for interacting with the Fabric network.
*   `system_requirements.md`: Document detailing system requirements.
*   `system_architecture.md`: Document detailing system architecture.
*   `RBAC_NOTES.md`: Notes on Role-Based Access Control implementation.
*   `TESTING_PLAN.md`: Plan used for system testing.
*   `todo.md`: Checklist of tasks performed.
*   `DEPLOYMENT_INSTRUCTIONS.md`: This file.

## 4. Deployment Steps

### Step 4.1: Set up the Hyperledger Fabric Network

1.  **Navigate to the Fabric scripts directory:**
    ```bash
    cd land-registry-fabric/scripts
    ```

2.  **Make the network script executable (if not already):**
    ```bash
    chmod +x network.sh
    ```

3.  **Generate Crypto Material and Channel Artifacts:**
    This step uses `cryptogen` and `configtxgen` to create certificates, keys, the genesis block, and channel configuration transactions. The `network.sh` script will attempt to download Fabric tools if they are not found in `../bin`.
    ```bash
    ./network.sh generate
    ```
    This will create `../crypto-config` and `../channel-artifacts` directories.

4.  **Start the Hyperledger Fabric Network:**
    This command will bring up the Docker containers for peers, orderers, and CAs as defined in `../docker-compose.yaml`. It will also create the application channel (`landchannel`), join peers to it, and update anchor peers.
    ```bash
    ./network.sh up
    ```
    *   Wait for the script to complete. You should see messages indicating successful channel creation and peer joining.
    *   You can check the status of Docker containers: `docker ps -a`.

### Step 4.2: Deploy and Instantiate Chaincode

The chaincode is located in the `chaincode/landregistry/javascript/` directory. The `cli` container in the Fabric network is used for chaincode lifecycle operations.

1.  **Package the Chaincode:**
    (This step is typically done inside the `cli` container or prepared beforehand. For this setup, we assume the chaincode source is mounted into the `cli` container as specified in `docker-compose.yaml` at `/opt/gopath/src/github.com/chaincode` which maps to `../chaincode/` relative to `docker-compose.yaml`.)

    Open a new terminal and enter the `cli` container:
    ```bash
    docker exec -it cli bash
    ```

    Inside the `cli` container, navigate to the peer CLI context (Org1 admin is default):
    ```bash
    # Environment variables for Org1 admin are usually pre-set in the cli container
    # To confirm:
    # echo $CORE_PEER_LOCALMSPID
    # echo $CORE_PEER_ADDRESS
    # echo $CORE_PEER_MSPCONFIGPATH
    ```

    Package the chaincode:
    ```bash
    cd /opt/gopath/src/github.com/chaincode/landregistry/javascript/
    npm install # Install dependencies if not already done
    cd /opt/gopath/src/github.com/chaincode/landregistry/
    peer lifecycle chaincode package landregistry.tar.gz --path javascript/ --lang node --label landregistry_1.0
    ```
    *   This creates `landregistry.tar.gz`.

2.  **Install Chaincode on Peers:**
    Install on `peer0.org1.example.com`:
    ```bash
    # Ensure you are in the cli container and CORE_PEER_ADDRESS is peer0.org1.example.com:7051
    # CORE_PEER_MSPCONFIGPATH should be Org1 Admin MSP
    export CORE_PEER_ADDRESS=peer0.org1.example.com:7051
    export CORE_PEER_LOCALMSPID="Org1MSP"
    export CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt
    export CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp
    
    peer lifecycle chaincode install /opt/gopath/src/github.com/chaincode/landregistry/landregistry.tar.gz
    ```
    Note the `Package ID` output (e.g., `landregistry_1.0:abcdef123...`). You will need this.
    Let `CC_PACKAGE_ID` be this package ID.

    Install on `peer0.org2.example.com`:
    Switch context to Org2 Admin:
    ```bash
    export CORE_PEER_ADDRESS=peer0.org2.example.com:9051
    export CORE_PEER_LOCALMSPID="Org2MSP"
    export CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt
    export CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/users/Admin@org2.example.com/msp
    
    peer lifecycle chaincode install /opt/gopath/src/github.com/chaincode/landregistry/landregistry.tar.gz
    ```

3.  **Approve Chaincode Definition for Organizations:**
    Approve for Org1:
    ```bash
    # Switch back to Org1 Admin context
    export CORE_PEER_ADDRESS=peer0.org1.example.com:7051
    export CORE_PEER_LOCALMSPID="Org1MSP"
    export CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt
    export CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp
    
    # Replace CC_PACKAGE_ID with the actual package ID from the install step
    # Example: export CC_PACKAGE_ID=landregistry_1.0:ccab9974595d8171aff938a026859996a946728ef8070889988f201f11f90ee3
    export CC_PACKAGE_ID=YOUR_CHAINCODE_PACKAGE_ID_HERE 
    
    peer lifecycle chaincode approveformyorg -o orderer.example.com:7050 --channelID landchannel --name landregistrycc --version 1.0 --sequence 1 --tls --cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem --package-id $CC_PACKAGE_ID
    ```

    Approve for Org2:
    ```bash
    # Switch to Org2 Admin context
    export CORE_PEER_ADDRESS=peer0.org2.example.com:9051
    export CORE_PEER_LOCALMSPID="Org2MSP"
    export CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt
    export CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/users/Admin@org2.example.com/msp
    
    peer lifecycle chaincode approveformyorg -o orderer.example.com:7050 --channelID landchannel --name landregistrycc --version 1.0 --sequence 1 --tls --cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem --package-id $CC_PACKAGE_ID
    ```

4.  **Check Commit Readiness:**
    ```bash
    # Can be run from either Org1 or Org2 Admin context
    peer lifecycle chaincode checkcommitreadiness --channelID landchannel --name landregistrycc --version 1.0 --sequence 1 --tls --cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem --output json
    ```
    Ensure both Org1MSP and Org2MSP show `true`.

5.  **Commit Chaincode Definition:**
    ```bash
    # Can be run from either Org1 or Org2 Admin context, but requires peer addresses from both orgs for endorsement
    peer lifecycle chaincode commit -o orderer.example.com:7050 --channelID landchannel --name landregistrycc --version 1.0 --sequence 1 --tls --cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem --peerAddresses peer0.org1.example.com:7051 --tlsRootCertFiles /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt --peerAddresses peer0.org2.example.com:9051 --tlsRootCertFiles /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt
    ```

6.  **Initialize Chaincode (Optional but recommended):**
    The chaincode has an `initLedger` function. Call it once after committing.
    ```bash
    # From Org1 Admin context
    peer chaincode invoke -o orderer.example.com:7050 --isInit --tls --cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem -C landchannel -n landregistrycc --peerAddresses peer0.org1.example.com:7051 --tlsRootCertFiles /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt --peerAddresses peer0.org2.example.com:9051 --tlsRootCertFiles /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt -c '{"function":"initLedger","Args":[]}'
    ```
    You can now exit the `cli` container: `exit`

### Step 4.3: Start the Web Application

1.  **Navigate to the web application directory:**
    ```bash
    cd land-registry-app
    ```

2.  **Install Node.js dependencies:**
    ```bash
    npm install
    ```

3.  **Run the server:**
    ```bash
    node server.js
    ```
    The server will start, typically on `http://localhost:3000`.
    It will attempt to enroll admin users and register application users (`Org1MSPUser`, `Org2MSPUser`) with the CAs and store their identities in the `land-registry-app/wallet/` directory.

4.  **Access the Application:**
    Open your web browser and go to `http://localhost:3000`.
    You should see the Land Registry Management System interface. Select a role to begin interacting with the system.

## 5. Stopping the System

1.  **Stop the Web Application:**
    Press `Ctrl+C` in the terminal where `node server.js` is running.

2.  **Stop the Hyperledger Fabric Network:**
    Navigate to `land-registry-fabric/scripts/` and run:
    ```bash
    ./network.sh down
    ```
    This will stop and remove Docker containers, volumes, and networks associated with the Fabric setup.

## 6. Cleaning the System (Optional)

If you want to remove all generated artifacts (crypto material, channel artifacts, chaincode packages, Docker volumes):

1.  Ensure the network is down: `./network.sh down`
2.  Navigate to `land-registry-fabric/scripts/` and run:
    ```bash
    ./network.sh clean
    ```
3.  Manually delete the `land-registry-app/wallet/` directory if you want to clear application identities.

## 7. Troubleshooting Tips

*   **Docker Permissions:** If you encounter Docker permission issues, ensure your user is part of the `docker` group or run Docker commands with `sudo`.
*   **Port Conflicts:** If any default ports (e.g., 7050, 7051, 3000) are in use, you may need to modify `docker-compose.yaml`, Fabric configurations, and `server.js` accordingly.
*   **Chaincode Errors:** Check the logs of the peer containers (`docker logs peer0.org1.example.com`) and the chaincode container (e.g., `docker logs dev-peer0.org1.example.com-landregistry_1.0-...`) for detailed error messages.
*   **Web App Errors:** Check the console output of `node server.js` and the browser's developer console for errors.
*   **File Paths:** Ensure all relative paths in scripts and configurations are correct based on your current working directory when executing commands.
*   **Fabric Tools Version:** Ensure the Fabric binaries (`cryptogen`, `configtxgen`) version matches the Fabric image versions used in `docker-compose.yaml` (e.g., `latest` often points to 2.5.x, ensure tools are also 2.5.x).

This concludes the deployment instructions. You should now have a running Land Registry Management System.
